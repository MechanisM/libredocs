<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- icons are 'document', 'brain', 'ruler', 'sync', 'newspaper' and 'cheerleader' from http://thenounproject.com/ -->
    <!-- svg editor is http://code.google.com/p/svg-edit/ -->
    <!-- most of the other stuff from http://unhosted.org -->
    <meta charset="utf-8">
    <title>Libre Docs</title>
    <link rel="icon" type="image/svg" href="../images/document.svg"/>
    <link rel="stylesheet" href="http://twitter.github.com/bootstrap/1.4.0/bootstrap.min.css">
    <script src="beFree/pimp.js"></script>
    <script src="beFree/files/base64.js"></script>
    <script src="beFree/files/sha1.js"></script>
    <script src="http://unhosted.nodejitsu.com/require.js" data-main="http://unhosted.nodejitsu.com/main"></script>
    <script src="/remoteStorageClient.js"></script>
    <script>
      remoteStorageClient.on('status', function(status) {
        document.getElementById('header').innerHTML = 'LibreDocs - '+status.userAddress+(status.background?'('+status.background+')':'');
        for(i in status.buttons) {
          document.getElementById('header').innerHTML += ' <input type="submit" value="'+status.buttons[i]+'" onclick="remoteStorageClient.'+status.buttons[i]+'();">';
        }
      });
      function showList() {
        var str = '';
        var docs = JSON.parse(localStorage.getItem('list'));
        if(localStorage.getItem('currDoc')) {
          var preview = localStorage.getItem('text'+localStorage.getItem('currDoc'));
          if(preview) {
            docs[localStorage.getItem('currDoc')].preview = preview.substring(0,80);
          } else {
            docs[localStorage.getItem('currDoc')].preview = '(empty)';
          }
          docs[localStorage.getItem('currDoc')].timestamp = new Date().getTime();
          localStorage.setItem('list', JSON.stringify(docs));
          localStorage.removeItem('currDoc');
        }
        for(i in docs) {
          str += '<tr onclick="showDoc('+i+');"><td><strong>'
            +docs[i].preview
            +'</td><td><em>'
            +docs[i].timestamp
            +'</em></td></tr>';
        }
        str += '<tr onclick="showDoc();"><td><strong>+(new)'
          +'</td><td><em>'
          +'</em></td></tr>';
        document.getElementById('list').innerHTML = str;
        document.getElementById('text').style.display='none';
        document.getElementById('backArrow').style.display='none';
        document.getElementById('list').style.display='block';
      }
      function showDoc(i) {
        if(!i) {
          i = new Date().getTime();
          localStorage.setItem('currDoc', i);
          var docs = JSON.parse(localStorage.getItem('list'));
          if(!docs) {
            docs = {};
          }
          docs[i] = {};
          docs[i].preview = '(new doc)';
          docs[i].timestamp = new Date().getTime();
          localStorage.setItem('list', JSON.stringify(docs));
        }
        localStorage.setItem('currDoc', i);
        document.getElementById('text').value=localStorage.getItem('text'+i);
        document.getElementById('text').style.display='block';
        document.getElementById('backArrow').style.display='block';
        document.getElementById('list').style.display='none';
      }
      window.addEventListener('storage', function(e) {
        if(e.key == 'text') {
          displayText();
        }
      }, false);
      function displayDocOrList() {
        if(localStorage.getItem('list')) {
          showList();
        } else {
          showDoc(localStorage.getItem('currDoc'));
        }
      }
    </script>
    <link rel="icon" type="image/svg" href="../images/document.svg" />
  </head>
  <body onload="displayDocOrList();remoteStorageClient.checkForLogin();">
      <h2 id="header">Libre Docs</h2>
    <div id="3" style="display:none;"><h2>Please sign up for easy freedom</h2>I, <input id="firstName" placeholder="first name"> <input id="lastName" placeholder="last name">, agree with the Terms of Service of IrisCouch.com. <input type="submit" value="Agree" onclick="remoteStorageClient.agree();">
    <br>
    <br>
    <br>
    <a href="/beFree/advanced.html">or choose for advanced freedom</a>.</div>
    <div class="row show-grid">
      <div id="backArrow" class="span3" onclick="showList();">
        <svg version="1.0" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="30px" height="30px" viewBox="0 0 99.934 100" enable-background="new 0 0 99.934 100" xml:space="preserve">
          <polygon points="0,75.161 0,0 75.165,0 99.934,24.769 42.75,24.769 98.944,80.893 80.753,99.083 24.771,43.171 24.771,100 0,75.161"/>
        </svg>
      </div>
    </div>
    <table class="zebra-striped" style="display:none;" id="list">
    </table>
    <textarea style="width:80%;height=80%;" id="text" onkeyup="localStorage.setItem('text'+localStorage.getItem('currDoc'), this.value);" autofocus></textarea>
  </body>
</html>
